```python
import pandas as pd
ss_data = pd.read_csv("sunspot.csv")

# 使用后50年的数据进行验证，以前的数据用于建模
train_data = ss_data[0:(rows - 50)]
n = train_data.shape[0]

# 设置候选门限值
thresholdV = train_data.sunspot.sort_values().values[np.int32(np.arange(30,70,3)/100*n)]

#设置最大门限延迟量dmax、自回归最大阶数、默认最小AIC值
dmax = 5
pmax = 5
minAIC = 1e+10
```

```python
# 在指定门限延迟量、阶数及门限值的前提下，返回对应自回归模型AIC值和自回归系数
def get_model_info(tsobj, d, p, r, isup=True):
    if isup:
        dst_set = np.where(tsobj > r)[0] + d
    else:
        dst_set = np.where(tsobj <= r)[0] + d
    
    tmpdata = None
    
    # 重建基础数据集
    # xt=a0+a1*x(t-1)+...+ap*x(t-p)
    for i in dst_set:
        if i>p and i < len(tsobj):
            if tmpdata is None:
                tmpdata = [tsobj[(i-p):(i+1)]]
            else:
                tmpdata = np.r_[tmpdata, [tsobj[(i-p):(i+1)]]]
    x = np.c_[[1]*tmpdata.shape[0],tmpdata[:,0:p]]
    coef = np.matmul(np.matmul(np.linalg.inv(np.matmul(x.T,x)),x.T),tmpdata[:,p])
    epsilon = tmpdata[:,p] - np.matmul(x,coef)
    aic = tmpdata.shape[0]*np.log(np.var(epsilon))+2*(p+2)
    return {"aic":aic, "coef":coef}
```

```python
# 选择最优参数
for tsv in thresholdV:
    for d in range(1,dmax+1):
        for p1 in range(1,pmax+1): # <= r
            model1 = get_model_info(train_data.sunspot.values, d, p=p1, r=tsv, isup=False)
            for p2 in range(1,pmax+1): # > r 
                model2 = get_model_info(train_data.sunspot.values, d, p=p2, r=tsv, isup=True)
                if model1['aic']+model2['aic'] < minAIC:
                    minAIC = model1['aic']+model2['aic']
                    a_tsv = tsv
                    a_d = d
                    a_p1 = p1
                    a_p2 = p2
                    coef1 = model1['coef']
                    coef2 = model2['coef']
                    print(minAIC)
# 1891.4713402264924
# 1755.538487229318
# ......
# 1613.7875399449235
# 1612.4584851226264
```

```python
import matplotlib.pyplot as plt
import matplotlib
matplotlib.rcParams['font.family'] = 'SimHei'
# 使用求出的参数，对后50年的数据逐年预测
predsData = []

for i in range(rows - 50,rows):
    t0 = ss_data.sunspot.values[i - a_d]
    if t0 <= a_tsv:
        predsData.append(np.sum(np.r_[1,ss_data.sunspot.values[(i-a_p1):i]]*coef1))
    else:
        predsData.append(np.sum(np.r_[1,ss_data.sunspot.values[(i-a_p2):i]]*coef2))


plt.figure(figsize=(10,6))
plt.plot(range(rows)[-100:rows],ss_data.sunspot[-100:rows],'-',c='black',linewidth=2,label="真实值")
plt.plot(range(rows)[-50:rows],predsData,'b--',label="预测值")
plt.xticks(range(rows)[-100:rows][::15],ss_data.year[-100:rows][::15],rotation=50)
plt.xlabel("$year$",fontsize=15)
plt.ylabel("$sunspot$",fontsize=15)
plt.legend()
plt.show()
```